# 서브쿼리
- 하나의 SQL문 안에 포함되어 있는 또 다른 SQL문, 서브쿼리는 알려지지 않은 기준을 이용한 검색을 위해 사용
- 서브 쿼리가 SQL문에서 사용 가능한 곳
  - SELECT, FROM, WHERE, HAVING 절
  - ORDER BY, INSERT문의 VALUES 절, UPDATE문의 SET 절
- 서브쿼리를 사용할 때 주의할 점
  - 서브쿼리를 괄호로 감싸서 사용한다.
  - 서브쿼리는 단일 행 또는 복수 행 비교 연산자와 함께 사용 가능
  - 서브쿼리에서는 ORDER BY를 사용하지 못한다.

### <동작하는 방식에 따른 서브쿼리 분류>
<table>
  <th>
    서브쿼리 종류
  <th> 설명</th>
  </th>
  <tr>
    <td>Un-Correlated(비연관) 서브쿼리
    <td> 서브쿼리가 메인쿼리 칼럼을 가지고 있지 않은 서브쿼리. 메인쿼리에 값을 제공하기 위한 목적으로 주로 사용
  </tr>
  <tr>
    <td>Correlated(연관) 서브쿼리
    <td> 서브쿼리가 메인쿼리 칼럼을 가지고 있는 서브쿼리. 메인쿼리가 먼저 수행되어 읽혀진 데이터를 서브쿼리에서 조건이 맞는지 확인하고자 할 때 주로 사용
  </tr>
  
</table>

### <반환되는 데이터의 형태에 따른 서브쿼리 분류>
<table>
  <th>
    서브쿼리 종류
  <th> 설명</th>
  </th>
  <tr>
    <td>Single Row 서브쿼리
    <td> 서브쿼리의 실행 결과가 항상 1건 이하인 서브쿼리, 단일 행 비교 연산자(=, <, <=, >, >=, <> 등)와 함께 사용된다.
  </tr>
  <tr>
    <td>Multi Row 서브쿼리
    <td> 서브쿼리의 실행 결과가 여러 건인 서브쿼리를 의미. 다중 행 서브쿼리는 다중 행 비교 연산자(IN, ALL, ANY, SOME, EXISTS)와 함께 사용
  </tr>
  <tr>
    <td>Multi Column 서브쿼리
    <td> 서브쿼리의 실행 결과로 여러 칼럼을 반환. 메인쿼리의 조건절에 여러 칼럼을 동시에 비교할 수 있다. 서브쿼리와 메인쿼리에서 비교하고자 하는 칼럼 개수와 칼럼의 위치가 동일해야 한다.
  </tr>
  
</table>

## 1. 단일 행 서브쿼리
- 서브쿼리의 실행 결과가 항상 1건 이하인 서브쿼리, 단일 행 비교 연산자(=, <, <=, >, >=, <> 등)와 함께 사용된다.
- 서브쿼리의 결과 건수가 2건 이상을 반환하면 SQL문은 실행시간 오류가 발생
- 테이블 전체에 하나의 그룹함수를 적용할 때는 그 결과값이 1건이 생성되기 때문에 단일 행 서브쿼리로서 사용 가능하다.

## 2. 다중 행 서브쿼리
- 서브쿼리의 실행 결과가 여러 건인 서브쿼리를 의미. 다중 행 서브쿼리는 다중 행 비교 연산자(IN, ALL, ANY, SOME, EXISTS)와 함께 사용

### 다중 행 비교 연산자
<table>
  <th>
    다중 행 연산자
  <th> 설명</th>
  </th>
  <tr>
    <td>IN (서브쿼리)
    <td> 서브쿼리의 결과에 존재하는 임의의 값과 동일한 조건을 의미
  </tr>
  <tr>
    <td>비교연산자 ALL (서브쿼리)
    <td> 서브쿼리의 결과에 존재하는 모든 값을 만족하는 조건을 의미
  </tr>
  <tr>
    <td>비교연산자 ANY (서브쿼리)
    <td> 서브쿼리의 결과에 존재하는 어느 하나의 값이라도 만족하는 조건을 의미. SOME은 ANY와 동일함.
  </tr>
  <tr>
    <td>EXISTS (서브쿼리)
    <td> 서브쿼리의 결과를 만족하는 값이 존재하는지 여부를 확인하는 조건을 의미.
  </tr>
</table>

## 3. 다중 칼럼 서브쿼리
- 서브쿼리의 결과로 여러 개의 칼럼이 반환되어 메인쿼리의 조건과 동시에 비교되는 것을 의미
- ex. 서브쿼리의 결과값 => 소속팀코드와 소속팀별 가장 작은 키를 의미하는 두 개의 칼럼을 반환
  - 소속팀별 키가 제일 작은 선수 한 명씩만 반환되는 것이 아니라, 같은 팀에서 여러 명이 반환 될 수 있다.
 
## 4. 연관 서브쿼리
- 서브쿼리 내에 메인쿼리 칼럼이 사용된 쿼리 (메인쿼리에 존재하는 모든 행에 대해서 반복 수행)
- EXISTS 서브쿼리는 항상 연관 서브쿼리로 사용
- EXISTS 서브쿼리는 아무리 조건을 만족하는 건이 여러 건이더라도 조건을 만족하는 1건만 찾으면 추가적인 검색을 진행하지 않는다.

## 5. 그밖에 위치에서 사용하는 서브쿼리
### 가. SELECT 절에 서브쿼리 사용하기
- 스칼라 서브쿼리 : 한 칼럼(1 row 1 column)만을 반환하는 서브쿼리
- 칼럼을 쓸 수 있는 대부분의 곳에서 스칼라 서브쿼리를 사용할 수 있다.
- 스칼라 서브쿼리 또한 단일 행 서브쿼리이기 때문에 결과가 2건 이상 반환되면 SQL문은 오류를 반환

### 나. FROM 절에서 서브쿼리 사용하기
- FROM 절에서 사용되는 서브쿼리를 인라인 뷰(inline view)라고 한다.
- 서브쿼리의 결과가 마치 동적으로 생성된 테이블인 것처럼 사용 => 데이터베이스에 해당 정보가 저장되지 않음
- 인라인 뷰는 테이블 명이 올 수 있는 곳에 사용할 수 있다.
- 인라인 뷰를 사용하는 것은 조인 방식을 사용하는 것과 같음 => 인라인 뷰의 칼럼은 SQL문에서 자유롭게 참조 가능

### 다. HAVING 절에서 서브쿼리 사용하기
- 그룹함수와 함께 사용될 때 그룹핑된 결과에 대해 부가적인 조건을 주기 위해서 사용

### 라. UPDATE문의 SET 절에서 사용하기
- SQLD_기본서통합본 p.202 참고 (예시)

### 마. INSERT문의 VALUES절에서 사용하기
- SQLD_기본서통합본 p.202 참고 (예시)

## 6. 뷰(view)
- 뷰는 실제 데이터는 가지고 있지 않고 정의만 가지고 있는 가상 테이블
- 뷰 생성 : CREATE VIEW 
- 테이블뿐만 아니라 이미 존재하는 뷰를 참조해서 생성 할 수 있음
- 뷰를 잘못 생성하는 경우 성능상의 문제를 유발할 수 있으므로, 뷰와 SQL 수행원리의 이해가 요구됨
- 뷰 제거 : DROP VIEW (뷰_이름)
